<!DOCTYPE html>
<html>
<head>
    <title>Resultados Restritos - ML</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f5f5f5; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        h1 { color: #3483fa; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        #app-status { margin-top: 20px; padding: 15px; border-radius: 5px; text-align: center; }
        .loading { background-color: #ffc; border: 1px solid #ff0; }
        .logged-in { background-color: #cfc; border: 1px solid #0c0; }
        #login-area { margin-top: 20px; text-align: center; }
        #data-content { display: none; } /* Esconde o conte√∫do at√© o login */
        .alert-error { background-color: #fdd; border: 1px solid #f00; color: #a00; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Resultados do Checklist (Acesso Restrito)</h1>
        <div id="app-status" class="loading">Iniciando o servi√ßo de autentica√ß√£o...</div>
        
        <div id="login-area">
            <p>Este conte√∫do √© restrito ao dom√≠nio @mercadolivre.com.</p>
            <div data-netlify-identity-widget></div>
            <button id="open-login-button" onclick="openNetlifyLogin()" style="margin-top: 15px; padding: 10px 20px; background-color: #3483fa; color: white; border: none; border-radius: 4px; cursor: pointer;">Clique para Fazer Login</button>
        </div>
        
        <div id="data-content">
            <p>‚úÖ **Login Autorizado.** Seus dados do formul√°rio salvo no Netlify **est√£o dispon√≠veis para an√°lise** no painel de controle do Netlify.</p>
            <p>Para ver a tabela de resultados nesta tela, precisar√≠amos de uma **Netlify Function**, mas o acesso est√° liberado para o dom√≠nio correto.</p>
            
            <button id="logout-button" style="margin-top: 20px; padding: 10px 20px; background-color: #d9534f; color: white; border: none; border-radius: 4px; cursor: pointer;">Sair / Logout</button>
        </div>
    </div>

    <script>
        const statusElement = document.getElementById('app-status');
        const loginArea = document.getElementById('login-area');
        const dataContent = document.getElementById('data-content');
        const openLoginButton = document.getElementById('open-login-button');
        const logoutButton = document.getElementById('logout-button');

        // URL BASE DO SEU SITE (Crucial para o Identity)
        const SITE_URL = 'https://meu-checklist-netlify.netlify.app';

        // FUN√á√ÉO CHAMADA PELO BOT√ÉO
        function openNetlifyLogin() {
            if (window.netlifyIdentity) {
                window.netlifyIdentity.open();
            } else {
                alert('Servi√ßo de Identidade do Netlify n√£o carregado. Tente recarregar a p√°gina.');
            }
        }

        if (window.netlifyIdentity) {
            
            // CONFIGURA√á√ÉO MANUAL PARA GARANTIR A URL DE REDIRECIONAMENTO CORRETA
            window.netlifyIdentity.config({
                siteURL: SITE_URL
            });
            
            // 1. Ocorre quando o widget carrega
            window.netlifyIdentity.on('init', (user) => {
                if (!user) {
                    statusElement.innerHTML = 'Status: **Desconectado.** Clique no bot√£o abaixo para login.';
                    statusElement.className = 'alert-error';
                    loginArea.style.display = 'block';
                    dataContent.style.display = 'none';
                    openLoginButton.style.display = 'block';
                } else {
                    displayUser(user);
                }
            });

            // 2. Ocorre ap√≥s o login bem-sucedido
            window.netlifyIdentity.on('login', (user) => {
                displayUser(user);
                window.netlifyIdentity.close();
            });
            
            // 3. Ocorre ap√≥s o logout
            window.netlifyIdentity.on('logout', () => {
                window.location.href = '/resultados.html';
            });
            
            // Fun√ß√£o de Logout
            logoutButton.addEventListener('click', () => {
                window.netlifyIdentity.logout();
            });
        }
        
        function displayUser(user) {
            statusElement.innerHTML = `‚úÖ **Logado com Sucesso!** Usu√°rio: <strong>${user.email}</strong>.`;
            statusElement.className = 'logged-in';
            loginArea.style.display = 'none';
            dataContent.style.display = 'block';
        }
    </script>
</body>
</html>
